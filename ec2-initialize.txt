#!/bin/sh

# This script initializes an Amazon EC2 instance
# for use as a text extraction worker node.
#

# must.have.root! 
if test $(id -u) != 0 ; then
  exec sudo /bin/sh $0
fi


PACKAGES=$(tr '\n' ' ' <<EOS)
%PACKAGES%
EOS

apt-get -y update

apt-get -y upgrade

apt-get install -y $PACKAGES

#git pull https://....fcc-textify

#Worker key
install -D -m 0600 /dev/stdin fcc-textify/auth <<EOS
%AUTH%
EOS

install -D -m 0600 /dev/stdin fcc-textify/config <<EOS
[default]
injector-queue = extraction-job-development
collector-queue = extraction-data-development
text-bucket = ppi-extraction-data-development

[aws]
region =  us-east-1
EOS

install -D -m 0755 /dev/stdin extract-job/run <<EOS
#!/bin/sh

authfile=$PWD/fcc-textify/auth

env AWS_ACCESS_KEY_ID="\$(sed -n 1p \$authfile)" \
    AWS_SECRET_ACCESS_KEY="\$(sed -n 2p \$authfile)" \
    exec python fcc-textify/task.py extract_batch
EOS

install -D -m 0755 /dev/stdin extract-job/log/run <<EOS
#!/bin/sh
d=\$HOME/logs
mkdir -p \$d
svlogd \$d
EOS

#ln -s extract-job /etc/service/extract-job
