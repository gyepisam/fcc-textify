#!/bin/sh

# DO NOT EDIT -- GENERATED FILE

# This script initializes an Amazon EC2 instance
# for use as a text extraction worker node.

# must.have.root! 
if test $(id -u) != 0 ; then
  exec sudo /bin/sh $0
fi


PACKAGES=$(tr '\n' ' ' <<EOS)
%PACKAGES%
EOS

apt-get -y update

apt-get -y upgrade

apt-get install -y $PACKAGES

HOME=/home/ubuntu
USER=ubuntu

cd $HOME

git clone https://github.com/gyepisam/fcc-textify

#Worker key
install -D -m 0600 /dev/stdin fcc-textify/auth <<EOS
%AUTH%
EOS

mode=%MODE%
install -D -m 0600 /dev/stdin fcc-textify/config/${mode}.ini <<EOS
[default]
injector-queue = extraction-job-$mode
collector-queue = extraction-data-$mode
text-bucket = ppi-extraction-data-$mode

[aws]
region =  us-east-1
EOS

install -D -m 0755 /dev/stdin runit/run <<EOS
#!/bin/sh

authfile=$HOME/fcc-textify/auth

exec chpst env \
  SHELL=/bin/sh \
  HOME=$HOME \
  AWS_ACCESS_KEY_ID="\$(sed -n 1p \$authfile)" \
  AWS_SECRET_ACCESS_KEY="\$(sed -n 2p \$authfile)" \
  python $HOME/fcc-textify/task.py extract_batch
EOS

install -D -m 0755 /dev/stdin runit/log/run <<EOS
#!/bin/sh
d=$HOME/logs
mkdir -p \$d
exec svlogd \$d
EOS

ln -s $PWD/runit /etc/service/textify
