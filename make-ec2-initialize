#!/usr/bin/perl

=begin

Generate an initialization file using the specified auth file
and stated requirements.

The resulting file can be run as a user-data script or manually.

=cut

use strict;

my $auth = slurp(shift @ARGV);
my $mode = shift @ARGV;

my %vars = (MODE => $mode, AUTH => $auth, PACKAGES => slurp('requirements.txt'));

my $template = slurp('ec2-initialize.txt');

while (my ($k, $v) = each %vars) {
    $v =~ s/\s+$//;
    $template =~ s/%${k}%/$v/;
}

print $template;

sub slurp {
    my $f = shift;
    local $/;
    open(F, $f) or die "cannot open $f. $!\n";
    <F>
}
